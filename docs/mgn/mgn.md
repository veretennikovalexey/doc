# mgn.md

Диспетчерская (все заказы) - Документы - Заказы торговли / ездки - Заказы за смену

Принято из EDI (24.08.2025 11:26:25) ДатИсп:25.08.2025

Программа _EDI_LD_ORDERS

## d:\Fabius\Opdata\EDI_log

```sql
SELECT *
FROM EDI_log
```

Размер 13,9 ГБ

## R641 (2) Контур

Документы ON_NSCHFDOPPR располагаются в папке

\\\WIN2008BUH\Fabius\Edi_qwerty\

## _EDI_LD_ORDERS

1. **Запуск процесса получения файлов с FTP**:  
   Программа запускает внешний Java-артефакт (`FtpLDForFab.jar`) для загрузки файлов заказов с FTP-сервера в локальный каталог.

2. **Проверка блокировки процесса**:  
   Проверяет наличие файла-блокировки (с расширением `.chk`) в целевом каталоге. Если обнаружена активная блокировка (созданная менее 0.15 часов назад), выводится сообщение о уже запущенном процессе и выполнение прерывается.

3. **Создание файла-блокировки**:  
   Создается новый файл-блокировка для предотвращения параллельного запуска.

4. **Поиск XML-файлов в каталоге**:  
   Рекурсивно сканирует целевой каталог и подкаталоги для поиска всех XML-файлов, соответствующих маске.

5. **Обработка каждого XML-файла**:  
   Для каждого найденного XML-файла выполняется:
   - **Парсинг XML**: Используется шаблон `LeraDataOrderToDpMHK.xtr` для преобразования XML-данных в структурированный формат.
   - **Валидация данных**: Проверяется наличие обязательных полей (например, номера заказа).
   - **Сопоставление кодов**:  
     - Поиск кода магазина (`R20`) по GLN-коду из поля `DELIVERYPLACE`.  
     - Определение кода организации-заказчика (`R01`) по коду магазина.  
     - Корректировка даты доставки с учетом времени в пути (если указано в справочнике `R456`).
   - **Проверка дубликатов**: Ищет существующие заказы с тем же номером и заказчиком в базе данных. Если найден, пропускает обработку.
   - **Логирование операции**: Записывает информацию о заказе в таблицу `EDI_log` (ID сообщения, даты, номера, GLN, содержимое файла и т.д.).
   - **Обработка позиций заказа**:  
     - Для каждой позиции ищется код товара (`R11`) по штрих-коду или внутреннему коду покупателя.  
     - Проверяется разрешена ли продукция к отгрузке для данного заказчика и магазина.  
     - Формируется массив позиций заказа с количеством.
   - **Обработка ошибок**: Если обнаружены неизвестные товары или запрещенные к отгрузке, выводится запрос на продолжение обработки.

6. **Фильтрация и выбор заказов для импорта**:  
   Пользователю предоставляется меню для выбора заказов по датам и магазинам. Только выбранные заказы будут импортированы.

7. **Импорт заказов в базу данных**:  
   - **Разделение на партии**: Большие списки заказов разбиваются на партии по 200 шт. для избежания проблем с производительностью.
   - **Удаление дубликатов**: Перед добавлением удаляются существующие записи заказов с теми же номерами и магазинами.
   - **Добавление шапок заказов**: Данные заносятся в таблицу `ZAK` (уровень 1).
   - **Обновление лога**: В таблице `EDI_log` обновляются номера документов (`RGNUM`) и другие детали.
   - **Добавление позиций заказа**: Данные заносятся в таблицу `ZAK` (уровень 2).

8. **Завершение операции**:  
   - Удаление обработанных XML-файлов и файлов-блокировок из каталога.
   - Закрытие открытых справочников и таблиц.
   - Вывод сообщения о завершении приема заказов.

9. **Вспомогательная функция `AllFiles`**:  
   Рекурсивно ищет все файлы по маске в указанном каталоге и его подкаталогах.